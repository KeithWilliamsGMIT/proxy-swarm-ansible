version: '3.6'
services:
  traefik:
    image: traefik:{{ traefik_version }}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ volume_directory }}/proxy/traefik/traefik.toml:/etc/traefik/traefik.toml"
      - "{{ volume_directory }}/proxy/traefik/acme/:/etc/traefik/acme/"
{% if is_using_local_ssl_certs  == true %}
      - "{{ volume_directory }}/proxy/traefik/certs/:/etc/traefik/certs/"
{% else %}
    environment:
      - DO_AUTH_TOKEN={{ do_api_token }}
{% endif %}
    deploy:
      labels:
        - "traefik.port=8080"
        - "traefik.backend=traefik"
        - "traefik.frontend.rule=Host:traefik.proxy.{{ domain_name }}"
        - "traefik.docker.network={{ docker_network_name }}"
        - "traefik.frontend.auth.basic={{ traefik_user }}:{{ traefik_password }}"
      mode: global
      placement:
        constraints:
          - node.role == manager
    networks:
      - {{ docker_network_name }}

{% if is_traefik_tracing_enabled == true %}
  jaeger:
    image: jaegertracing/all-in-one:{{ jaeger_version }}
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "9411:9411"
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
    deploy:
      labels:
        - "traefik.port=16686"
        - "traefik.backend=jaeger"
        - "traefik.frontend.rule=Host:jaeger.proxy.{{ domain_name }}"
        - "traefik.docker.network={{ docker_network_name }}"
      mode: replicated
      replicas: 1
    networks:
      - {{ docker_network_name }}
{% endif %}

networks:
  {{ docker_network_name }}:
    external: true
    name: {{ docker_network_name }}